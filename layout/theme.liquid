<!doctype html>
<html class='no-js' lang='{{ shop.locale }}'>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
    <meta name='viewport' content='width=device-width,initial-scale=1'>
    <meta name='theme-color' content='{{ settings.color_button }}'>
    <link rel='canonical' href='{{ canonical_url }}'>

    {%- if canonical_url != blank -%}
      <link rel='canonical' href='{{ canonical_url }}'>
    {%- endif -%}

    {%- if settings.favicon != blank -%}
      <link
        rel='shortcut icon'
        href='{{ settings.favicon | img_url: '32x32' }}'
        type='image/png'
      >
    {%- endif -%}

    <link rel='preconnect' href='https://cdn.shopify.com' crossorigin>
    {% comment %} <link rel="preconnect" href="https://monorail-edge.shopifysvc.com"> {% endcomment %}

    <script
      src='https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.js'
      defer='defer'
    ></script>
    <link
      rel='stylesheet'
      href='https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.css'
    >

    <script
      src='https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js'
      defer='defer'
    ></script>
    <script
      src='https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/ScrollTrigger.min.js'
      defer='defer'
    ></script>

    <script src='{{ 'constants.js' | asset_url }}' defer='defer'></script>
    <script src='{{ 'pubsub.js' | asset_url }}' defer='defer'></script>
    <script src='{{ 'global.js' | asset_url }}' defer='defer'></script>
    <script src='{{ 'animate-eyebrow.js' | asset_url }}' defer='defer'></script>

    {%- capture seo_title -%}
      {%- if request.page_type == 'search' and search.performed == true -%}
        {{ 'general.search.heading' | t: count: search.results_count }}: {{ 'general.search.results_with_count' | t: terms: search.terms, count: search.results_count }}
      {%- else -%}
        {{ page_title }}
      {%- endif -%}
      {%- if current_tags -%}
        {%- assign meta_tags = current_tags | join: ', ' -%} &ndash; {{ 'general.meta.tags' | t: tags: meta_tags -}}
      {%- endif -%}
      {%- if current_page != 1 -%}
        &ndash; {{ 'general.meta.page' | t: page: current_page }}
      {%- endif -%}
      {%- assign escaped_page_title = page_title | escape -%}
      {%- unless escaped_page_title contains shop.name -%}
        &ndash; {{ shop.name }}
      {%- endunless -%}
    {%- endcapture -%}

    {%- unless settings.type_header_font.system?
      and settings.type_body_font.system?
    -%}
      <link rel='preconnect' href='https://fonts.shopifycdn.com' crossorigin>
    {%- endunless -%}

    <title>
      {%- if request.page_type == 'password' -%}
        {{ shop.name }} &ndash; {{ 'general.password_page.opening_soon' | t }}
      {%- else -%}
        {{ page_title }}
        {%- if current_tags %}
          &ndash; tagged "{{ current_tags | join: ', ' }}"
        {%- endif -%}
        {%- if current_page != 1 %} &ndash; Page {{ current_page }}{% endif -%}
        {%- unless page_title contains shop.name %}
          &ndash; {{ shop.name -}}
        {%- endunless -%}
      {%- endif -%}
    </title>

    {% if page_description %}
      <meta name='description' content='{{ page_description | escape }}'>
    {% endif %}

    <!-- CSS LOADING BASE + VARIABLES -->
    {{ 'base.css' | asset_url | stylesheet_tag }}
    {{ 'grid.css' | asset_url | stylesheet_tag }}
    {{ 'animate-eyebrow.css' | asset_url | stylesheet_tag }}

    {% render 'social-meta-tags' %}

    {{ content_for_header }}

    {%- assign header_font = settings.type_header_font -%}
    {%- assign base_font = settings.type_base_font -%}
    {%- assign base_font_bolder = base_font
      | font_modify: 'weight', 'bolder'
    -%}
    {%- assign base_font_bold = base_font | font_modify: 'weight', 'bold' -%}
    {%- assign base_font_italic = base_font | font_modify: 'style', 'italic' -%}
    {%- assign base_font_bold_italic = base_font_bold
      | font_modify: 'style', 'italic'
    -%}

    {%- liquid
      assign body_font_bold = settings.type_body_font | font_modify: 'weight', 'bold'
      assign body_font_italic = settings.type_body_font | font_modify: 'style', 'italic'
      assign body_font_bold_italic = body_font_bold | font_modify: 'style', 'italic'
    %}

    {% render 'css-variables' %}

    <!-- Critical CSS for above-the-fold content -->
    <style>
      {% render 'critical-css' %}
    </style>

    <style>
      {{ header_font | font_face: font_display: 'swap' }}
      {{ base_font | font_face: font_display: 'swap' }}
      {{ base_font_bold | font_face: font_display: 'swap' }}
      {{ base_font_bolder | font_face: font_display: 'swap' }}
      {{ base_font_italic | font_face: font_display: 'swap' }}
      {{ base_font_bold_italic | font_face: font_display: 'swap' }}
    </style>

    <script>
      var theme = {
        breakpoints: {
          medium: 750,
          large: 990,
          widescreen: 1400
        },
        strings: {
          addToCart: {{ 'products.product.add_to_cart' | t | json }},
          soldOut: {{ 'products.product.sold_out' | t | json }},
          unavailable: {{ 'products.product.unavailable' | t | json }},
          regularPrice: {{ 'products.product.regular_price' | t | json }},
          salePrice: {{ 'products.product.sale_price' | t | json }},
          sale: {{ 'products.product.on_sale' | t | json }},
          fromLowestPrice: {{ 'products.product.from_lowest_price_html' | t: lowest_price: '[price]' | json }},
          vendor: {{'products.product.vendor' | t | json }},
          showMore: {{ 'general.filters.show_more' | t | json }},
          showLess: {{ 'general.filters.show_less' | t | json }},
          searchFor: {{ 'general.search.search_for' | t | json }},
          addressError: {{ 'sections.map.address_error' | t | json }},
          addressNoResults: {{ 'sections.map.address_no_results' | t | json }},
          addressQueryLimit: {{ 'sections.map.address_query_limit_html' | t | json }},
          authError: {{ 'sections.map.auth_error_html' | t | json }},
          newWindow: {{ 'general.accessibility.link_messages.new_window' | t | json }},
          external: {{ 'general.accessibility.link_messages.external' | t | json }},
          newWindowExternal: {{ 'general.accessibility.link_messages.new_window_and_external' | t | json }},
          removeLabel: {{ 'cart.label.remove' | t: product: '[product]' | json }},
          update: {{ 'cart.label.update' | t | json }},
          quantity: {{ 'cart.label.quantity' | t | json }},
          discountedTotal: {{ 'cart.label.discounted_total' | t | json }},
          regularTotal: {{ 'cart.label.regular_total' | t | json }},
          priceColumn: {{ 'cart.label.price_column' | t | json }},
          quantityMinimumMessage: {{ 'products.product.quantity_minimum_message' | t | json }},
          cartError: {{ 'cart.general.cart_error' | t | json }},
          removedItemMessage: {{ 'cart.general.removed_item_html' | t: quantity: '[quantity]', link: '[link]' | json }},
          unitPrice: {{ 'products.product.unit_price_label' | t | json }},
          unitPriceSeparator: {{ 'general.accessibility.unit_price_separator' | t | json }},
          oneCartCount: {{ 'cart.popup.cart_count' | t: count: 1 | json }},
          otherCartCount: {{ 'cart.popup.cart_count' | t: count: '[count]' | json }},
          quantityLabel: {{ 'cart.popup.quantity_label' | t: quantity_count: '[count]' | json }},
          products: {{ 'general.search.products' | t | json }},
          loading: {{ 'general.search.loading' | t | json }},
          number_of_results: {{ 'general.search.number_of_results' | t: result_number: '[result_number]', results_count: '[results_count]' | json }},
          number_of_results_found: {{ 'general.search.number_of_results_found' | t: results_count: '[results_count]' | json }},
          one_result_found: {{ 'general.search.one_result_found' | t | json }}
        },
        moneyFormat: {{ shop.money_format | json }},
        moneyFormatWithCurrency: {{ shop.money_with_currency_format | json }},
        settings: {
          predictiveSearchEnabled: {{ settings.predictive_search_enabled | json }},
          predictiveSearchShowPrice: {{ settings.predictive_search_show_price | json }},
          predictiveSearchShowVendor: {{ settings.predictive_search_show_vendor | json }}
        },
        stylesheet: "{{ 'theme.css' | asset_url }}"
      }

      document.documentElement.className = document.documentElement.className.replace('no-js', 'js');
    </script>

    <!-- CUSTOMERS PAGE JS -->
    {%- if request.page_type contains 'customers/' -%}
      <script
        src='{{ 'shopify_common.js' | shopify_asset_url }}'
        defer='defer'
      ></script>
    {%- endif -%}

    <script type='text/javascript'>
      if (window.MSInputMethodContext && document.documentMode) {
        var scripts = document.getElementsByTagName('script')[0];
        var polyfill = document.createElement('script');
        polyfill.defer = true;
        polyfill.src = "{{ 'ie11CustomProperties.min.js' | asset_url }}";

        scripts.parentNode.insertBefore(polyfill, scripts);
      }
    </script>

    <!-- CONTENT FOR HEADER -->
    {{ content_for_header }}
  </head>

  <body class='template-{{ request.page_type | handle }}'>
    <a class='in-page-link visually-hidden skip-link' href='#MainContent'>
      {{- 'general.accessibility.skip_to_content' | t -}}
    </a>

    <div data-sticky-header>
      {% if settings.show_announcement_bar %}
        {% section 'announcement-bar' %}
      {% endif %}

      {% section 'header' %}
    </div>

    <div class='page-wrapper drawer-page-content' id='PageContainer'>
      <main
        class='main-content js-focus-hidden'
        id='MainContent'
        role='main'
        tabindex='-1'
      >
        {{ content_for_layout }}
      </main>

      {% render 'svg-symbols' %}
      {% section 'hae-footer' %}

      <div id='slideshow-info' class='visually-hidden' aria-hidden='true'>
        {{- 'sections.slideshow.navigation_instructions' | t -}}
      </div>
    </div>

    <ul hidden>
      <li id='a11y-refresh-page-message'>
        {{ 'general.accessibility.refresh_page' | t }}
      </li>
      <li id='a11y-selection-message'>
        {{ 'general.accessibility.selection_help' | t }}
      </li>
    </ul>

    <script>
      window.shopUrl = '{{ request.origin }}';
      window.routes = {
        cart_add_url: '{{ routes.cart_add_url }}',
        cart_change_url: '{{ routes.cart_change_url }}',
        cart_update_url: '{{ routes.cart_update_url }}',
        cart_url: '{{ routes.cart_url }}',
        cart_get_url: 'cart.js',
        predictive_search_url: '{{ routes.predictive_search_url }}',
      };

      window.mediaQueries = {
        mediumUp: window.matchMedia('(min-width: 600px)'),
        largeUp: window.matchMedia('(min-width: 940px)'),
      };

      window.cartStrings = {
        error: `{{ 'sections.cart.cart_error' | t }}`,
        quantityError: `{{ 'sections.cart.cart_quantity_error_html' | t: quantity: '[quantity]' }}`,
      };

      window.variantStrings = {
        addToCart: `{{ 'products.product.add_to_cart' | t }}`,
        soldOut: `{{ 'products.product.sold_out' | t }}`,
        unavailable: `{{ 'products.product.unavailable' | t }}`,
        currentOptionSoldOut: `Selected size is sold out`,
      };

      window.accessibilityStrings = {
        imageAvailable: `{{ 'products.product.media.image_available' | t: index: '[index]' }}`,
        shareSuccess: `{{ 'general.share.success_message' | t }}`,
        pauseSlideshow: `{{ 'sections.slideshow.pause_slideshow' | t }}`,
        playSlideshow: `{{ 'sections.slideshow.play_slideshow' | t }}`,
      };
    </script>

    <script src='https://a.klaviyo.com/media/js/onsite/onsite.js'></script>
    <script>
      var klaviyo = klaviyo || [];
      klaviyo.init({
        account: '{{ settings.klaviyo_account_id }}',
        platform: 'shopify',
        collection_urls: ['/collections/'],
      });
      klaviyo.enable('backinstock', {
        trigger: {
          product_page_text: 'Notify Me When Available',
          product_page_class: 'button',
          product_page_text_align: 'center',
          product_page_margin: '0px',
          replace_anchor: false,
        },
        modal: {
          headline: '{product_name}',
          body_content:
            'Register to receive a notification when this item comes back in stock.',
          email_field_label: 'Email',
          button_label: 'Notify me when available',
          subscription_success_label:
            "You're in! We'll let you know when it's back.",
          footer_content: '',
          additional_styles:
            "@import url('https://fonts.googleapis.com/css?family=Helvetica+Neue');",
          drop_background_color: '#000',
          background_color: '#fff',
          text_color: '#222',
          button_text_color: '#fff',
          button_background_color: '#439fdb',
          close_button_color: '#ccc',
          error_background_color: '#fcd6d7',
          error_text_color: '#C72E2F',
          success_background_color: '#d3efcd',
          success_text_color: '#1B9500',
        },
      });

      // Initialize collection page back in stock triggers
      function initKlaviyoCollectionTriggers() {
        const triggers = document.querySelectorAll(
          '.klaviyo-bis-trigger-collection'
        );
        console.log('Found ' + triggers.length + ' Klaviyo BIS triggers');

        triggers.forEach(function (trigger) {
          trigger.addEventListener('click', function (e) {
            e.preventDefault();
            e.stopPropagation();

            const variantId = this.getAttribute('data-variant-id');
            console.log('Klaviyo BIS clicked for variant:', variantId);

            if (variantId) {
              // Check if Klaviyo is available and try to open the form
              if (typeof window._klOnsite !== 'undefined') {
                console.log('Using _klOnsite.push method');
                window._klOnsite.push([
                  'openForm',
                  'backinstock',
                  { variant: variantId },
                ]);
              } else if (typeof klaviyo !== 'undefined') {
                console.log('Using klaviyo.push method');
                klaviyo.push([
                  'openForm',
                  'backinstock',
                  { variant: variantId },
                ]);
              } else {
                console.error('Klaviyo not found');
              }
            }
          });
        });
      }

      // Wait for Klaviyo to load, then initialize triggers
      var klaviyoLoadCheck = setInterval(function () {
        if (
          typeof window._klOnsite !== 'undefined' ||
          typeof klaviyo !== 'undefined'
        ) {
          clearInterval(klaviyoLoadCheck);
          console.log('Klaviyo loaded, initializing collection triggers');
          initKlaviyoCollectionTriggers();
        }
      }, 100);
    </script>
    {% comment %} START - Smartrr Custom script {% endcomment %}
    <script>
      {% assign formatted_price = product.price | money %}
      {% assign discounted_price = product.price | times: 0.85 | round %}
      {% assign formatted_discounted_price = discounted_price | money %}

      (function () {
        const TARGET_CLASS = 'smartrr-selling-plan-group-name';
        const INJECTED_FLAG = 'data-smartrr-prices-injected';

        const FULL_PRICE = "{{ formatted_price }}";
        const DISCOUNTED_PRICE = "{{ formatted_discounted_price }}";
        const CURRENCY_CODE = "{{ shop.currency }}";

        function injectIntoElements(root = document) {
          const elements = root.querySelectorAll(`.${TARGET_CLASS}:not([${INJECTED_FLAG}])`);

          elements.forEach(el => {
            const isOTP = el.closest('.smartrr-otp') !== null;

            let comparePrice = '';
            let subscribePrice = '';

            if (isOTP) {
              subscribePrice = FULL_PRICE;
            } else {
              comparePrice = FULL_PRICE;
              subscribePrice = DISCOUNTED_PRICE;
            }

            const markup = `
              <div
                data-smartrr-product-id="{{ product.id }}"
                data-smartrr-price-style=""
                data-smartrr-currency="${CURRENCY_CODE}"
                data-use-quantity="true"
              >
                <span data-smartrr-compare-price>${comparePrice}</span>
                <span data-smartrr-subscribe-price>${subscribePrice}</span>
                <span data-smartrr-regular-price>${comparePrice}</span>
              </div>
            `;

            el.insertAdjacentHTML('beforeend', markup);
            el.setAttribute(INJECTED_FLAG, 'true');
          });
        }

        injectIntoElements();

        const observer = new MutationObserver(mutations => {
          mutations.forEach(mutation => {
            mutation.addedNodes.forEach(node => {
              if (node.nodeType === 1) {
                injectIntoElements(node);
              }
            });
          });
        });

        observer.observe(document.body, {
          childList: true,
          subtree: true
        });
      })();
    </script>
    {% comment %} START - Smartrr Custom script {% endcomment %}
  </body>
</html>
